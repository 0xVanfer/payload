<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Integration Test</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'SF Mono', 'Monaco', monospace;
      background: #1e1e2e;
      color: #e0e0e0;
      padding: 2rem;
    }
    .test { margin: 1rem 0; padding: 1rem; background: #2a2a3e; border-radius: 8px; }
    .pass { border-left: 4px solid #10b981; }
    .fail { border-left: 4px solid #ef4444; }
    pre { white-space: pre-wrap; word-break: break-all; font-size: 12px; margin-top: 0.5rem; }
    h2 { color: #7c3aed; }
  </style>
</head>
<body>
  <h1>Quick Integration Test</h1>
  <div id="results"></div>
  
  <script type="module">
    import { decodePayload, splitPayloadIntoCalls } from '../js/core/decoder.js';
    import { extractSelector, checksumAddress } from '../js/core/abi-utils.js';
    import { detectMulticallType, isMulticall } from '../js/core/multicall.js';
    import { isExecTransaction, isMultiSend } from '../js/core/safe.js';
    import { detectLinkType, isParsableLink } from '../js/parsers/index.js';
    
    const results = document.getElementById('results');
    
    function addResult(name, passed, details = '') {
      const div = document.createElement('div');
      div.className = `test ${passed ? 'pass' : 'fail'}`;
      div.innerHTML = `<strong>${passed ? '✓' : '✗'} ${name}</strong>`;
      if (details) {
        div.innerHTML += `<pre>${details}</pre>`;
      }
      results.appendChild(div);
    }
    
    // Test 1: Extract selector
    try {
      const selector = extractSelector('0xa9059cbb000000000000000000000000dac6748cbb7cd9da1868eb7ad598273122f012db0000000000000000000000000000000000000000000000000de0b6b3a7640000');
      addResult('extractSelector - ERC20 transfer', selector === '0xa9059cbb', `Got: ${selector}`);
    } catch (e) {
      addResult('extractSelector - ERC20 transfer', false, e.message);
    }
    
    // Test 2: Checksum address
    try {
      const addr = checksumAddress('0xdac6748cbb7cd9da1868eb7ad598273122f012db');
      addResult('checksumAddress', addr === '0xDaC6748Cbb7cd9Da1868EB7AD598273122F012Db', `Got: ${addr}`);
    } catch (e) {
      addResult('checksumAddress', false, e.message);
    }
    
    // Test 3: Detect multicall type
    try {
      // Uniswap V3 multicall selector
      const type = detectMulticallType('0x5ae401dc');
      addResult('detectMulticallType - Uniswap V3', type === 'multicall_v3', `Got: ${type}`);
    } catch (e) {
      addResult('detectMulticallType - Uniswap V3', false, e.message);
    }
    
    // Test 4: Detect Safe execTransaction
    try {
      const isExec = isExecTransaction('0x6a761202');
      addResult('isExecTransaction', isExec === true, `Got: ${isExec}`);
    } catch (e) {
      addResult('isExecTransaction', false, e.message);
    }
    
    // Test 5: Detect multiSend
    try {
      const isMulti = isMultiSend('0x8d80ff0a');
      addResult('isMultiSend', isMulti === true, `Got: ${isMulti}`);
    } catch (e) {
      addResult('isMultiSend', false, e.message);
    }
    
    // Test 6: Detect link type - Etherscan
    try {
      const type = detectLinkType('https://etherscan.io/tx/0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef');
      addResult('detectLinkType - Etherscan', type === 'etherscan', `Got: ${type}`);
    } catch (e) {
      addResult('detectLinkType - Etherscan', false, e.message);
    }
    
    // Test 7: Detect link type - Tenderly
    try {
      const type = detectLinkType('https://dashboard.tenderly.co/explorer/vnet/123/tx/0x1234');
      addResult('detectLinkType - Tenderly', type === 'tenderly', `Got: ${type}`);
    } catch (e) {
      addResult('detectLinkType - Tenderly', false, e.message);
    }
    
    // Test 8: isParsableLink
    try {
      const parsable = isParsableLink('https://etherscan.io/tx/0x1234');
      const notParsable = isParsableLink('0xa9059cbb');
      addResult('isParsableLink', parsable === true && notParsable === false, `URL: ${parsable}, Payload: ${notParsable}`);
    } catch (e) {
      addResult('isParsableLink', false, e.message);
    }
    
    // Test 9: Split payload - single call
    try {
      const payload = '0xa9059cbb000000000000000000000000dac6748cbb7cd9da1868eb7ad598273122f012db0000000000000000000000000000000000000000000000000de0b6b3a7640000';
      const calls = splitPayloadIntoCalls(payload);
      addResult('splitPayloadIntoCalls - single call', calls.length === 1, `Got ${calls.length} call(s)`);
    } catch (e) {
      addResult('splitPayloadIntoCalls - single call', false, e.message);
    }
    
    // Test 10: Full decode with signature lookup
    try {
      const payload = '0xa9059cbb000000000000000000000000dac6748cbb7cd9da1868eb7ad598273122f012db0000000000000000000000000000000000000000000000000de0b6b3a7640000';
      const result = await decodePayload(payload);
      addResult(
        'decodePayload - ERC20 transfer', 
        result && result.length > 0,
        `Results: ${JSON.stringify(result, null, 2).slice(0, 500)}...`
      );
    } catch (e) {
      addResult('decodePayload - ERC20 transfer', false, e.message);
    }
    
    // Summary
    const passCount = document.querySelectorAll('.test.pass').length;
    const failCount = document.querySelectorAll('.test.fail').length;
    const summary = document.createElement('h2');
    summary.textContent = `Summary: ${passCount} passed, ${failCount} failed`;
    results.appendChild(summary);
  </script>
</body>
</html>
